---
title: "git commit --amendをするときに気を付けること"
emoji: "🌟"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Git]
published: false
---

## 対象読者
gitの操作を一通り触ってみたぐらいの初級者向け

## `git commit --amend`はコミットメッセージの修正だよね？
はい、`--amend`オプションを付けることによって、直前のコミット（HEADポインタがあるコミット？）のコミットメッセージの修正を行うことが出来ます。これは、調べたら直ぐに出てきて、gitを少し触ったことがある人以上であれば周知の事実だと思います。

## 前提条件は

- ローカルリポジトリからプッシュしていない

これです。
当たり前かもしれないですが、`git commit --amend`ではプッシュ済みのコミットは直せません。`git commit`のオプションだからですね。ローカルリポジトリのコミットを変更するものですので、リモートリポジトリにあるコミットはこのコマンドでは修正できません。最後にプッシュ済みのコミットの修正についても書きます。

## ローカルリポジトリからプッシュした後にコマンドを打つとどうなるのか
ローカルリポジトリからプッシュをして、ローカルとリモートの状態を最新状態で一致させてから、`git commit --amend`を行うと、HEADのコミットが打ち消されてHEADの元の親コミットから新たにコミットが生成されます。
ローカルとリモートリポジトリの状態が、`A`の状態から`B`というコミットをして、HEADがそれぞれBにあるとします。

```mermaid
graph LR
    A --> B
```

ここで、`B`のコミットメッセージを修正したいと思って、`git commit --amend`とすると、ローカルリポジトリでは、

```mermaid
graph LR
    A --> C
```

というように、`A`から派生されて`C`のコミットが作られます。

リモートリポジトリでは、

```mermaid
graph LR
    A --> B
```

と、変更されていない状態です。
このままプッシュしても、Gitからは「リモートリポジトリの方が先に進んでいて、履歴が違うからmergeするなりしてどうにか直してね」と言われます。

## リモートリポジトリにプッシュ後のコミットの修正方法
主に二つあると思っていますが、コミットメッセージの修正のみであれば変な事書いていない限り修正する必要はないと思います。
一つ目は、`git reset`をして戻ってから修正して、`git push --force`をすること。これは、コミット履歴を強引に書き換えるので他の人が`git pull`でPCに既にコミットを取り込んでいたらコンフリクトの原因となります。なるべくしないようにしましょう。
二つ目は、`git revert`で、コミット内容を打ち消すためのコミットを生成します。`git reset`との違いは、コミット履歴を破壊するかしないかです。本当に修正したければ、こちらを使うと良いでしょう。
ちなみに、`git reset`のオプションには三種類あって、--soft,--mixed,--hardとあり、それぞれHEADの位置（作業する位置）とステージング環境と作業ツリーが変更されます。図解で見たい人はこちら[^1]を参照してください。

## 最後に
gitのコマンドを打つときには、作業環境に何のファイルがあるのかや前提条件をしっかり確認しながら使いましょう。特に、--forceや--hardなどのオプションを使う時にはいつも以上に環境に何があるのかを確認しましょう。初級者の頃は、作業ツリーとステージング環境とローカルリポジトリ、そしてリモートリポジトリの状態を見ながら一つずつ理解するといいかもしれませんね。壊しながら学べるようなリポジトリを作るのもお勧めです。
`git commit --amend`で、コミットが打ち消されずに親コミットから派生しているとずっと勘違いして記事を9割書いていました。VSCodeの拡張機能のGitLensや`git log --graph`を使いながら、今までの履歴やポインタを確認すると良いと思います。


[^1]: https://www.r-staffing.co.jp/engineer/entry/20191129_1